blueprint:
  name: Automation for Dim and Switch Lights
  description: Pretty complex automation with a lot of helper entities
  domain: automation
  input:
    light_entity:
      name: Light
      description: The light that shall be controlled.
      selector:
        target:
          entity:
            domain: light
    automation_switch:
      name: Automation Switch
      description: Switching the automation function on or off without deactivating the HA automation
      selector:
        target:
          entity:
            domain: input_boolean
    helper_effective_brightness:
      name: Helper Effective Brightness
      description: Helper Entity (sensor), that keeps the current effective brightness
      selector:
        target:
          entity:
            domain: sensor
    helper_basic_brightness:
      name: Helper Basic Brightness
      description: Helper Entity (sensor), that keeps the current basic brightness
      selector:
        target:
          entity:
            domain: sensor
    transition_time:
      name: Transition Time
      description: Time in s
      selector:
        number:
          min: 0
          max: 10
          step: 1
          unit_of_measurement: steps
          mode: slider
      default: 1

mode: queued
max: 20
max_exceeded: silent

variables:
  transition_time: !input transition_time
  helper_effective_brightness: !input helper_effective_brightness
  helper_basic_brightness: !input helper_basic_brightness

trigger:
  - platform: state
    entity_id: !input automation_switch
    id: app_switch
    to: 'on'
  - platform: homeassistant
    event: start
    id: ha_start
  - platform: state
    entity_id: binary_sensor.helper_light_trigger_e_ba_regal
    id: motion_on
    from: "off"
    to: "on"
  - platform: state
    entity_id: binary_sensor.helper_light_trigger_e_ba_regal
    id: motion_off
    from: "on"
    to: "off"
  - platform: state
    entity_id: sensor.helper_light_switching_off_entities_e_ba_regal
    id: switching_off_entities
  - platform: state
    entity_id: binary_sensor.helper_light_is_too_dark_e_ba_regal
    id: too_dark
    to: "on"
  - platform: state
    entity_id: binary_sensor.helper_light_is_too_bright_e_ba_regal
    id: too_bright
    to: "on"
  - platform: state
    entity_id: !input light_entity
    id: light_on_or_off
  - platform: state
    entity_id: binary_sensor.helper_light_keeping_on_entities_e_ba_regal
    id: keeping_on_ended
    to: "off"
  - platform: state
    entity_id: binary_sensor.helper_light_keeping_off_entities_e_ba_regal
    id: keeping_off_ended
    to: "off"
  - platform: state
    entity_id: binary_sensor.helper_light_keeping_fix_entities_e_ba_regal
    attribute: brightness
    id: keeping_fix_brightness_changed
  - platform: state
    entity_id: sensor.helper_light_effective_brightness_e_ba_regal
    id: effective_brightness_changed

action:
  - choose:
    - conditions:
      - condition: or
        conditions:
          - condition: trigger
            id: app_switch
          - condition: trigger
            id: ha_start
      sequence:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.helper_light_auto_switched_e_ba_regal
      - choose:
        - conditions:
          - condition: trigger
            id: ha_start
          sequence:
          - service: input_boolean.turn_off
            target:
              entity_id: input_boolean.helper_light_manually_switched_off_e_ba_regal
          - service: input_boolean.turn_off
            target:
              entity_id: input_boolean.helper_light_manually_switched_on_e_ba_regal
        default: []
      - choose:
        - conditions:
          - condition: state
            entity_id: binary_sensor.helper_light_keeping_fix_entities_e_ba_regal
            state: 'off'
          sequence:
          - choose:
            - conditions:
              - condition: state
                entity_id: binary_sensor.helper_light_trigger_e_ba_regal
                state: 'on'
              sequence:
              - choose:
                - conditions:
                  - condition: state
                    entity_id: binary_sensor.helper_light_is_too_dark_e_ba_regal
                    state: 'on'
                  sequence:
                  - condition: state
                    entity_id: !input automation_switch
                    state: 'on'
                  - condition: state
                    state: 'off'
                    entity_id: binary_sensor.helper_light_keeping_off_entities_e_ba_regal
                  - condition: state
                    state: 'off'
                    entity_id: input_boolean.helper_light_manually_switched_off_e_ba_regal
                  - choose:
                    - conditions:
                      - condition: state
                        entity_id: !input light_entity
                        state: 'off'
                      sequence:
                      - service: input_boolean.turn_on
                        target:
                          entity_id: input_boolean.helper_light_auto_switched_e_ba_regal
                    default: []
                  - service: light.turn_on
                    target:
                      entity_id: !input light_entity
                    data_template:
                      brightness_pct: >
                        {{ states(helper_effective_brightness) | int(80) }}
                      transition: >
                        {{ transition_time }}
                # path 2
                - conditions:
                  - condition: state
                    entity_id: binary_sensor.helper_light_is_too_bright_e_ba_regal
                    state: 'on'
                  sequence:
                  - condition: state
                    entity_id: !input automation_switch
                    state: 'on'
                  - condition: state
                    state: 'off'
                    entity_id: binary_sensor.helper_light_keeping_on_entities_e_ba_regal
                  - condition: state
                    state: 'off'
                    entity_id: input_boolean.helper_light_manually_switched_on_e_ba_regal
                  - choose:
                    - conditions:
                      - condition: state
                        entity_id: !input light_entity
                        state: 'on'
                      sequence:
                      - service: input_boolean.turn_on
                        target:
                          entity_id: input_boolean.helper_light_auto_switched_e_ba_regal
                    default: []
                  - service: light.turn_off
                    target:
                      entity_id: !input light_entity
                default: []
            - conditions:
              - condition: state
                entity_id: binary_sensor.helper_light_trigger_e_ba_regal
                state: 'off'
              sequence:
              - condition: state
                entity_id: !input automation_switch
                state: 'on'
              - condition: state
                state: 'off'
                entity_id: binary_sensor.helper_light_keeping_on_entities_e_ba_regal
              - choose:
                - conditions:
                  - condition: state
                    entity_id: !input light_entity
                    state: 'on'
                  sequence:
                  - service: input_boolean.turn_on
                    target:
                      entity_id: input_boolean.helper_light_auto_switched_e_ba_regal
                default: []
              - service: light.turn_off
                target:
                  entity_id: !input light_entity
            default: []
        # path 4
        - conditions:
          - condition: state
            entity_id: binary_sensor.helper_light_keeping_fix_entities_e_ba_regal
            state: 'on'
          sequence:
          - condition: state
            entity_id: !input automation_switch
            state: 'on'
          - choose:
            - conditions:
              - condition: state
                entity_id: !input light_entity
                state: 'off'
              sequence:
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.helper_light_auto_switched_e_ba_regal
            default: []
          - service: light.turn_on
            target:
              entity_id: !input light_entity
            data_template:
              brightness_pct: >
                {{ states(helper_effective_brightness) | int(80) }}
              transition: >
                {{ transition_time }}
        default: []
    # path 5
    - conditions:
      - condition: trigger
        id: motion_on
      sequence:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.helper_light_manually_switched_off_e_ba_regal
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.helper_light_manually_switched_on_e_ba_regal
      - condition: state
        entity_id: !input automation_switch
        state: 'on'
      - condition: state
        entity_id: binary_sensor.helper_light_keeping_off_entities_e_ba_regal
        state: 'off'
      - condition: state
        entity_id: binary_sensor.helper_light_keeping_fix_entities_e_ba_regal
        state: 'off'
      - condition: state
        entity_id: binary_sensor.helper_light_is_too_dark_e_ba_regal
        state: 'on'
      - choose:
        - conditions:
          - condition: state
            entity_id: !input light_entity
            state: 'off'
          sequence:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.helper_light_auto_switched_e_ba_regal
        default: []
      - service: light.turn_on
        target:
          entity_id: !input light_entity
        data_template:
          brightness_pct: >
            {{ states(helper_effective_brightness) | int(5) }}
          transition: >
            {{ transition_time }}
    # path 6
    - conditions:
      - condition: trigger
        id: motion_off
      sequence:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.helper_light_manually_switched_on_e_ba_regal
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.helper_light_manually_switched_off_e_ba_regal
      - condition: state
        entity_id: !input automation_switch
        state: 'on'
      - condition: state
        entity_id: binary_sensor.helper_light_keeping_on_entities_e_ba_regal
        state: 'off'
      - condition: state
        entity_id: binary_sensor.helper_light_keeping_fix_entities_e_ba_regal
        state: 'off'
      - choose:
        - conditions:
          - condition: state
            entity_id: !input light_entity
            state: 'on'
          sequence:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.helper_light_auto_switched_e_ba_regal
        default: []
      - service: light.turn_off
        target:
          entity_id: !input light_entity
    # path 7
    - conditions:
      - condition: trigger
        id: switching_off_entities
      sequence:
      - condition: template
        value_template: '{{ is_number(trigger.to_state.state) }}'
      - condition: template
        value_template: '{{ is_number(trigger.from_state.state) }}'
      - condition: template
        value_template: '{{ (trigger.to_state.state | float(0)) > (trigger.from_state.state | float(1)) }}'
      - condition: state
        entity_id: !input automation_switch
        state: 'on'
      - choose:
        - conditions:
          - condition: state
            entity_id: !input light_entity
            state: 'on'
          sequence:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.helper_light_auto_switched_e_ba_regal
        default: []
      - service: light.turn_off
        target:
          entity_id: !input light_entity
    # path 8
    - conditions:
      - condition: trigger
        id: too_dark
      sequence:
      - condition: state
        entity_id: !input automation_switch
        state: 'on'
      - condition: state
        entity_id: binary_sensor.helper_light_trigger_e_ba_regal
        state: 'on'
      - condition: state
        entity_id: binary_sensor.helper_light_keeping_off_entities_e_ba_regal
        state: 'off'
      - condition: state
        entity_id: binary_sensor.helper_light_keeping_fix_entities_e_ba_regal
        state: 'off'
      - condition: state
        entity_id: input_boolean.helper_light_manually_switched_off_e_ba_regal
        state: 'off'
      - choose:
        - conditions:
          - condition: state
            entity_id: !input light_entity
            state: 'off'
          sequence:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.helper_light_auto_switched_e_ba_regal
        default: []
      - service: light.turn_on
        target:
          entity_id: !input light_entity
        data_template:
          brightness_pct: >
            {{ states(helper_effective_brightness) | int(80) }}
          transition: >
            {{ transition_time }}
    # path 9
    - conditions:
      - condition: trigger
        id: too_bright
      sequence:
      - condition: state
        entity_id: !input automation_switch
        state: 'on'
      - condition: state
        entity_id: binary_sensor.helper_light_keeping_on_entities_e_ba_regal
        state: 'off'
      - condition: state
        entity_id: binary_sensor.helper_light_keeping_fix_entities_e_ba_regal
        state: 'off'
      - condition: state
        entity_id: input_boolean.helper_light_manually_switched_on_e_ba_regal
        state: 'off'
      - choose:
        - conditions:
          - condition: state
            entity_id: !input light_entity
            state: 'on'
          sequence:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.helper_light_auto_switched_e_ba_regal
        default: []
      - service: light.turn_off
        target:
          entity_id: !input light_entity
    # path 10
    - conditions:
      - condition: trigger
        id: light_on_or_off
      sequence:
      - choose:
        - conditions:
          - condition: state
            entity_id: input_boolean.helper_light_auto_switched_e_ba_regal
            state: 'off'
          sequence:
          - choose:
            - conditions:
              - condition: template
                value_template: >
                  {{ trigger.to_state.state == 'on' }}
              sequence:
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.helper_light_manually_switched_on_e_ba_regal
            # path 11
            - conditions:
              - condition: template
                value_template: >
                  {{ trigger.to_state.state == 'off' }}
              sequence:
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.helper_light_manually_switched_off_e_ba_regal
            default: []
        # path 12
        - conditions:
          - condition: state
            entity_id: input_boolean.helper_light_auto_switched_e_ba_regal
            state: 'on'
          sequence:
          - service: input_boolean.turn_off
            target:
              entity_id: input_boolean.helper_light_auto_switched_e_ba_regal
        default: []
    # path 13
    - conditions:
      - condition: trigger
        id: keeping_off_ended
      sequence:
      - condition: state
        entity_id: !input automation_switch
        state: 'on'
      - condition: state
        entity_id: binary_sensor.helper_light_trigger_e_ba_regal
        state: 'on'
      - condition: state
        entity_id: binary_sensor.helper_light_is_too_dark_e_ba_regal
        state: 'on'
      - condition: state
        entity_id: input_boolean.helper_light_manually_switched_off_e_ba_regal
        state: 'off'
      - condition: state
        entity_id: binary_sensor.helper_light_keeping_fix_entities_e_ba_regal
        state: 'off'
      - choose:
        - conditions:
          - condition: state
            entity_id: !input light_entity
            state: 'off'
          sequence:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.helper_light_auto_switched_e_ba_regal
        default: []
      - service: light.turn_on
        target:
          entity_id: !input light_entity
        data_template:
          brightness_pct: >
            {{ states(helper_effective_brightness) | int(80) }}
          transition: >
            {{ transition_time }}
    # path 14
    - conditions:
      - condition: trigger
        id: keeping_on_ended
      sequence:
      - choose:
        - conditions:
          - condition: state
            entity_id: binary_sensor.helper_light_trigger_e_ba_regal
            state: 'on'
          sequence:
          - condition: state
            entity_id: !input automation_switch
            state: 'on'
          - condition: state
            entity_id: binary_sensor.helper_light_is_too_dark_e_ba_regal
            state: 'off'
          - condition: state
            entity_id: input_boolean.helper_light_manually_switched_on_e_ba_regal
            state: 'off'
          - condition: state
            entity_id: binary_sensor.helper_light_keeping_fix_entities_e_ba_regal
            state: 'off'
          - choose:
            - conditions:
              - condition: state
                entity_id: !input light_entity
                state: 'on'
              sequence:
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.helper_light_auto_switched_e_ba_regal
            default: []
          - service: light.turn_off
            target:
              entity_id: !input light_entity
        # path 15
        - conditions:
          - condition: state
            entity_id: binary_sensor.helper_light_trigger_e_ba_regal
            state: 'off'
          sequence:
          - condition: state
            entity_id: !input automation_switch
            state: 'on'
          - condition: state
            entity_id: binary_sensor.helper_light_keeping_fix_entities_e_ba_regal
            state: 'off'
          - choose:
            - conditions:
              - condition: state
                entity_id: !input light_entity
                state: 'on'
              sequence:
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.helper_light_auto_switched_e_ba_regal
            default: []
          - service: light.turn_off
            target:
              entity_id: !input light_entity
    # path 16
    - conditions:
      - condition: trigger
        id: keeping_fix_brightness_changed
      - condition: state
        entity_id: !input automation_switch
        state: 'on'
      sequence:
      - choose:
        - conditions:
          - condition: template
            value_template: >
              {{ (trigger.to_state.state | int(0)) > 0 }}
          sequence:
          - choose:
            - conditions:
              - condition: state
                entity_id: !input light_entity
                state: 'off'
              sequence:
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.helper_light_auto_switched_e_ba_regal
            default: []
          - service: light.turn_on
            target:
              entity_id: !input light_entity
            data_template:
              brightness_pct: >
                {{ trigger.to_state.state | int(80) }}
              transition: >
                {{ transition_time }}
          # path 17
        - conditions:
          - condition: template
            value_template: >
              {{ (trigger.to_state.state | int(0)) == 0 }}
          sequence:
          - choose:
            - conditions:
              - condition: state
                entity_id: binary_sensor.helper_light_trigger_e_ba_regal
                state: 'on'
              sequence:
              - choose:
                - conditions:
                  - condition: state
                    entity_id: binary_sensor.helper_light_is_too_dark_e_ba_regal
                    state: 'on'
                  sequence:
                  - condition: state
                    entity_id: binary_sensor.helper_light_keeping_off_entities_e_ba_regal
                    state: 'off'
                  - condition: state
                    entity_id: input_boolean.helper_light_manually_switched_off_e_ba_regal
                    state: 'off'
                  - choose:
                    - conditions:
                      - condition: state
                        entity_id: !input light_entity
                        state: 'off'
                      sequence:
                      - service: input_boolean.turn_on
                        target:
                          entity_id: input_boolean.helper_light_auto_switched_e_ba_regal
                    default: []
                  - service: light.turn_on
                    target:
                      entity_id: !input light_entity
                    data_template:
                      brightness_pct: >
                        {{ trigger.to_state.state | int(80) }}
                      transition: >
                        {{ transition_time }}
                # path 18
                - conditions:
                  - condition: state
                    entity_id: binary_sensor.helper_light_is_too_dark_e_ba_regal
                    state: 'off'
                  sequence:
                  - condition: state
                    entity_id: binary_sensor.helper_light_keeping_on_entities_e_ba_regal
                    state: 'off'
                  - condition: state
                    entity_id: input_boolean.helper_light_manually_switched_on_e_ba_regal
                    state: 'off'
                  - choose:
                    - conditions:
                      - condition: state
                        entity_id: !input light_entity
                        state: 'on'
                      sequence:
                      - service: input_boolean.turn_on
                        target:
                          entity_id: input_boolean.helper_light_auto_switched_e_ba_regal
                    default: []
                  - service: light.turn_off
                    target:
                      entity_id: !input light_entity
                default: []
            # path 19
            - conditions:
              - condition: state
                entity_id: binary_sensor.helper_light_trigger_e_ba_regal
                state: 'off'
              sequence:
              - condition: state
                entity_id: binary_sensor.helper_light_keeping_on_entities_e_ba_regal
                state: 'off'
              - condition: state
                entity_id: input_boolean.helper_light_manually_switched_on_e_ba_regal
                state: 'off'
              - choose:
                - conditions:
                  - condition: state
                    entity_id: !input light_entity
                    state: 'on'
                  sequence:
                  - service: input_boolean.turn_on
                    target:
                      entity_id: input_boolean.helper_light_auto_switched_e_ba_regal
                default: []
              - service: light.turn_off
                target:
                  entity_id: !input light_entity
            default: []
        default: []
    # path 20
    - conditions:
      - condition: trigger
        id: effective_brightness_changed
      sequence:
      - condition: template
        value_template: >
          {{ (trigger.to_state.state | int(0)) != (states(helper_basic_brightness) | int(0)) }}
      - condition: state
        entity_id: !input automation_switch
        state: 'on'
      - condition: state
        entity_id: !input light_entity
        state: 'on'
      - service: light.turn_on
        target:
          entity_id: !input light_entity
        data_template:
          brightness_pct: >
            {{ trigger.to_state.state | int(80) }}
          transition: >
            {{ transition_time }}
    default: []