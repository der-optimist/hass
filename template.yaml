# Trigger based
  - trigger:
      - platform: state
        entity_id: sensor.wirkungsgrad_wechselrichter
        for: "00:00:05"
    sensor:
      - name: Wirkungsgrad Wechselrichter gefiltert
        state: '{{ states("sensor.wirkungsgrad_wechselrichter") }}'
        unit_of_measurement: '%'
#
# State based
  - sensor:
      # Helper entities for light automation
      # Deckenlicht GZ
      - name: helper_light_basic_brightness_o_gz_deckenlicht
        unit_of_measurement: "%"
        state: >
          {% set hours = 
            ['00:00','08:00',20],
            ['08:01','09:00',60],
            ['09:01','10:00',80],
            ['10:01','20:00',100],
            ['20:01','22:00',70],
            ['22:01','23:00',40],
            ['23:01','23:59',20] %}
          {% set t = states('sensor.time').replace(':','')|int %}
          {% for h in hours if (h[0].replace(':','')|int) <= t <= (h[1].replace(':','')|int) %}
              {{h[2]}}
          {% endfor %}
      - name: helper_light_effective_brightness_o_gz_deckenlicht
        unit_of_measurement: "%"
        state: >
          {{ states('sensor.helper_light_basic_brightness_o_gz_deckenlicht') }}
      - name: helper_light_min_illuminance_o_gz_deckenlicht
        unit_of_measurement: "lx"
        state: >
          {% set hours = 
            ['00:00','05:00',10],
            ['05:01','06:30',20],
            ['06:31','09:00',30],
            ['09:01','17:00',40],
            ['17:01','19:00',30],
            ['19:01','23:00',20],
            ['23:01','23:59',10] %}
          {% set t = states('sensor.time').replace(':','')|int %}
          {% for h in hours if (h[0].replace(':','')|int) <= t <= (h[1].replace(':','')|int) %}
              {{h[2]}}
          {% endfor %}
      #
      # Regal Bad EG
      - name: helper_light_basic_brightness_e_ba_regal
        unit_of_measurement: "%"
        state: >
          {% set hours = 
            ['00:00','06:00',60],
            ['06:01','07:00',70],
            ['07:01','17:00',80],
            ['17:01','18:00',70],
            ['18:01','23:59',60] %}
          {% set t = states('sensor.time').replace(':','')|int %}
          {% for h in hours if (h[0].replace(':','')|int) <= t <= (h[1].replace(':','')|int) %}
              {{h[2]}}
          {% endfor %}
      - name: helper_light_effective_brightness_e_ba_regal
        unit_of_measurement: "%"
        state: >
          {{ states('sensor.helper_light_basic_brightness_e_ba_regal') }}
      - name: helper_light_min_illuminance_e_ba_regal
        unit_of_measurement: "lx"
        state: >
          {% set hours = 
            ['00:00','06:00',10],
            ['06:01','07:00',25],
            ['07:01','08:00',40],
            ['08:01','17:00',50],
            ['17:01','18:00',40],
            ['18:01','23:59',30] %}
          {% set t = states('sensor.time').replace(':','')|int %}
          {% for h in hours if (h[0].replace(':','')|int) <= t <= (h[1].replace(':','')|int) %}
              {{h[2]}}
          {% endfor %}
    #
    # Mapping of "raw" sensors to constant names
      - unique_id: el_leistung_heizung_partyraum_vorne
        # name: change entity_id in UI after creation
        unit_of_measurement: "W"
        state: >
          {{ states('sensor.el_leistung_esp_sd_4') }}
        attributes:
          friendly_name: "El. Leistung Heizung Partyraum vorne"
      - unique_id: el_leistung_heizung_partyraum_hinten
        # name: change entity_id in UI after creation
        unit_of_measurement: "W"
        state: >
          {{ states('sensor.el_leistung_esp_sd_5') }}
        attributes:
          friendly_name: "El. Leistung Heizung Partyraum hinten"
      - unique_id: el_leistung_luftentfeuchter_partyraum
        # name: change entity_id in UI after creation
        unit_of_measurement: "W"
        state: >
          {{ states('sensor.el_leistung_esp_sd_6') }}
        attributes:
          friendly_name: "El. Leistung Luftentfeuchter Partyraum"
      - unique_id: el_leistung_luftentfeuchter_waschkueche
        # name: change entity_id in UI after creation
        unit_of_measurement: "W"
        state: >
          {{ states('sensor.el_leistung_innr_sp_120_luftentfeuchter_waschkuche') }}
        attributes:
          friendly_name: "El. Leistung Luftentfeuchter WaschkÃ¼che"
      - unique_id: el_leistung_hebeanlage
        # name: change entity_id in UI after creation
        unit_of_measurement: "W"
        state: >
          {{ states('sensor.el_leistung_shellyplug_s_169d16_power') }}
        attributes:
          friendly_name: "El. Leistung Hebeanlage"
    ### Binary Sensor
    #
    binary_sensor:
      # Helper entities for light automation
      # Deckenlicht GZ
      - name: helper_light_trigger_o_gz_deckenlicht
        state: >
          {{ is_state('binary_sensor.pm_o_gz', 'on') }}
      - name: helper_light_keeping_off_entities_o_gz_deckenlicht
        state: >
          {{ is_state('switch.gaste_schlafen', 'on')
             or is_state('switch.luften_le', 'on') }}
      - name: helper_light_keeping_on_entities_o_gz_deckenlicht
        state: >
          {{ False }}
      - name: helper_light_keeping_fix_entities_o_gz_deckenlicht
        state: >
          {{ False }}
        attributes:
          brightness: >
            {{ 0 }}
      - name: helper_light_is_too_dark_o_gz_deckenlicht
        state: >
          {{ (states("sensor.helligkeit_gastezimmer_pm") | float) < (states("sensor.helper_light_min_illuminance_o_gz_deckenlicht") | float) }}
      - name: helper_light_is_too_bright_o_gz_deckenlicht
        state: >
          {{ (states("sensor.helligkeit_gastezimmer_pm") | float) > (states("sensor.helper_light_min_illuminance_o_gz_deckenlicht") | float + 100 ) }}
      # Regal Bad EG
      - name: helper_light_trigger_e_ba_regal
        state: >
          {{ is_state('binary_sensor.pm_e_ba', 'on') }}
      - name: helper_light_keeping_off_entities_e_ba_regal
        state: >
          {{ is_state('switch.majo_schlafen', 'on') }}
      - name: helper_light_keeping_on_entities_e_ba_regal
        state: >
          {{ False }}
      - name: helper_light_keeping_fix_entities_e_ba_regal
        state: >
          {{ False }}
        attributes:
          brightness: >
            {{ 0 }}
      - name: helper_light_is_too_dark_e_ba_regal
        state: >
          {{ (states("sensor.helligkeit_bad_eg_pm") | float) < (states("sensor.helper_light_min_illuminance_e_ba_regal") | float) }}
      - name: helper_light_is_too_bright_e_ba_regal
        state: >
          {{ (states("sensor.helligkeit_bad_eg_pm") | float) > (states("sensor.helper_light_min_illuminance_e_ba_regal") | float + 100 ) }}